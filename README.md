# å‚¬åŒ–å‰‚å¼‚ç‰©å¼‚å½¢æ£€æµ‹ç³»ç»Ÿ

ä¸€ä¸ªåŸºäºæ·±åº¦å­¦ä¹ UNetæ¨¡å‹çš„å·¥ä¸šå‚¬åŒ–å‰‚å›¾åƒåˆ†æç³»ç»Ÿï¼Œä¸“é—¨ç”¨äºæ£€æµ‹å‚¬åŒ–å‰‚ä¸­çš„å¼‚ç‰©å’Œå¼‚å½¢ç¼ºé™·ã€‚

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

æœ¬é¡¹ç›®æ˜¯ä¸€ä¸ªå®Œæ•´çš„å·¥ä¸šè§†è§‰æ£€æµ‹è§£å†³æ–¹æ¡ˆï¼Œä¸»è¦ç”¨äºå‚¬åŒ–å‰‚ç”Ÿäº§è´¨é‡æ§åˆ¶ã€‚ç³»ç»Ÿé€šè¿‡UNetæ·±åº¦å­¦ä¹ æ¨¡å‹è¿›è¡Œå›¾åƒåˆ†å‰²ï¼Œç»“åˆå…ˆè¿›çš„å›¾åƒå¤„ç†ç®—æ³•å’Œç»Ÿè®¡åˆ†ææ–¹æ³•ï¼Œå®ç°å¯¹å‚¬åŒ–å‰‚å¼‚ç‰©å’Œå¼‚å½¢çš„æ™ºèƒ½æ£€æµ‹ä¸åˆ†ç±»ã€‚

### ğŸ¯ ä¸»è¦åŠŸèƒ½

- **å›¾åƒåˆ†å‰²**: åŸºäºUNetæ¨¡å‹çš„ç²¾å‡†åƒç´ çº§åˆ†å‰²
- **å¼‚ç‰©æ£€æµ‹**: æ™ºèƒ½è¯†åˆ«å‚¬åŒ–å‰‚ä¸­çš„å¤–æ¥ç‰©è´¨
- **å¼‚å½¢æ£€æµ‹**: æ£€æµ‹å˜å½¢ã€ç ´æŸçš„å‚¬åŒ–å‰‚é¢—ç²’
- **è¿é€šåŸŸåˆ†æ**: æ·±åº¦åˆ†æåˆ†å‰²åŒºåŸŸçš„å‡ ä½•ç‰¹å¾
- **æ™ºèƒ½è¯¯æŠ¥è¿‡æ»¤**: é‡‡ç”¨å¤šé‡ç®—æ³•å‡å°‘è¯¯æ£€
- **ç»Ÿè®¡åˆ†æ**: å…¨é¢çš„æ•°æ®ç»Ÿè®¡å’Œå¯è§†åŒ–
- **æ‰¹é‡å¤„ç†**: æ”¯æŒå¤§æ‰¹é‡å›¾åƒè‡ªåŠ¨åŒ–å¤„ç†

## ğŸš€ æ ¸å¿ƒç‰¹æ€§

### 1. æ™ºèƒ½æ£€æµ‹ç®—æ³•
- **UNetæ·±åº¦å­¦ä¹ æ¨¡å‹**: é«˜ç²¾åº¦åƒç´ çº§åˆ†å‰²
- **è¿é€šåŸŸåˆå¹¶**: æ™ºèƒ½åˆå¹¶è¢«åˆ†å‰²çš„å•ä¸€å‚¬åŒ–å‰‚
- **å¤šç‰¹å¾ç»¼åˆåˆ¤æ–­**: é¢ç§¯ã€é•¿å®½æ¯”ã€å®å¿ƒåº¦ç­‰å¤šç»´åº¦åˆ†æ
- **è‡ªé€‚åº”é˜ˆå€¼**: æ ¹æ®ç»Ÿè®¡åˆ†å¸ƒåŠ¨æ€è°ƒæ•´æ£€æµ‹å‚æ•°

### 2. è¯¯æŠ¥æŠ‘åˆ¶æŠ€æœ¯  
- **å¯†åº¦æ£€æµ‹**: åŸºäºåƒç´ å¯†åº¦çš„è¯¯æŠ¥è¯†åˆ«
- **å½¢æ€å­¦åˆ†æ**: é€šè¿‡å½¢çŠ¶ç‰¹å¾è¿‡æ»¤å™ªå£°
- **è¯„åˆ†æœºåˆ¶**: å¤šå› å­ç»¼åˆè¯„åˆ†ç³»ç»Ÿ
- **è¾¹ç¼˜æ£€æµ‹**: æ’é™¤å›¾åƒè¾¹ç¼˜çš„å¹²æ‰°åŒºåŸŸ

### 3. å¯è§†åŒ–ä¸åˆ†æ
- **ç»“æœå¯è§†åŒ–**: ç›´è§‚çš„æ£€æµ‹ç»“æœæ ‡æ³¨å’Œå±•ç¤º
- **ç»Ÿè®¡æŠ¥å‘Š**: è¯¦ç»†çš„æ•°æ®åˆ†æå’Œå›¾è¡¨ç”Ÿæˆ
- **æ‰¹é‡åˆ†æ**: æ”¯æŒå¤§è§„æ¨¡æ•°æ®é›†çš„ç»Ÿè®¡åˆ†æ
- **å¯¼å‡ºåŠŸèƒ½**: å¤šæ ¼å¼ç»“æœæ•°æ®å¯¼å‡º

## ğŸ› ï¸ æŠ€æœ¯æ ˆ

- **æ·±åº¦å­¦ä¹ æ¡†æ¶**: PyTorch
- **è®¡ç®—æœºè§†è§‰**: OpenCV
- **æ•°æ®å¤„ç†**: NumPy, SciPy
- **å¯è§†åŒ–**: Matplotlib, Seaborn
- **å®éªŒç®¡ç†**: Weights & Biases (wandb)
- **æ•°æ®æ ¼å¼**: LMDB, PIL/Pillow
- **å¼€å‘è¯­è¨€**: Python 3.x

## ğŸ“¦ å®‰è£…é…ç½®

### ç¯å¢ƒè¦æ±‚

- Python >= 3.7
- CUDA >= 10.0 (GPUåŠ é€Ÿï¼Œå¯é€‰)
- å†…å­˜ >= 8GB
- æ˜¾å­˜ >= 4GB (ä½¿ç”¨GPUæ—¶)

### å®‰è£…æ­¥éª¤

1. **å…‹éš†é¡¹ç›®**
```bash
git clone <project-url>
cd catelyzer_seg
```

2. **å®‰è£…ä¾èµ–**
```bash
pip install -r requirements.txt
```

3. **å‡†å¤‡é¢„è®­ç»ƒæ¨¡å‹**
```bash
# å°†é¢„è®­ç»ƒæ¨¡å‹æ”¾ç½®åˆ° pretrained/ ç›®å½•
mkdir -p pretrained
# ä¸‹è½½æˆ–å¤åˆ¶æ¨¡å‹æ–‡ä»¶åˆ° pretrained/twoimages_epoch1000.pth
```

4. **Dockeréƒ¨ç½² (å¯é€‰)**
```bash
docker build -t catalyst-detector .
docker run --gpus all -v $(pwd):/workspace/unet catalyst-detector
```

## ğŸ® ä½¿ç”¨æ–¹æ³•

### 1. å¼‚ç‰©å¼‚å½¢æ£€æµ‹

ä½¿ç”¨ä¸»æ£€æµ‹è„šæœ¬è¿›è¡Œå‚¬åŒ–å‰‚å¼‚ç‰©å¼‚å½¢æ£€æµ‹ï¼š

```bash
# åŸºç¡€æ£€æµ‹
python merge_test_yiwu.py pretrained/twoimages_epoch1000.pth \
  --input-dir ./data/test_images \
  --output-dir ./results

# ä½¿ç”¨é¢„é…ç½®è„šæœ¬
bash 02_merge_test_yiwu.sh
```

#### ä¸»è¦å‚æ•°è¯´æ˜

**æ£€æµ‹å‚æ•°**:
- `--min-component-area`: è¿é€šåŸŸæœ€å°é¢ç§¯é˜ˆå€¼ (é»˜è®¤: 500)
- `--min-area`: å¼‚ç‰©æœ€å°é¢ç§¯ (é»˜è®¤: 500)  
- `--max-area`: å¼‚ç‰©æœ€å¤§é¢ç§¯ (é»˜è®¤: 20000)
- `--min-aspect-ratio`: æœ€å°é•¿å®½æ¯” (é»˜è®¤: 2.0)
- `--max-aspect-ratio`: æœ€å¤§é•¿å®½æ¯” (é»˜è®¤: 20.0)
- `--min-solidity`: æœ€å°å®å¿ƒåº¦ (é»˜è®¤: 0.8)

**æ™ºèƒ½åˆå¹¶å‚æ•°**:
- `--enable-component-merge`: å¯ç”¨è¿é€šåŸŸæ™ºèƒ½åˆå¹¶
- `--merge-distance`: åˆå¹¶è·ç¦»é˜ˆå€¼ (é»˜è®¤: 20)
- `--merge-angle-threshold`: åˆå¹¶è§’åº¦é˜ˆå€¼ (é»˜è®¤: 30åº¦)

**è¯¯æŠ¥è¿‡æ»¤å‚æ•°**:
- `--enable-false-positive-filter`: å¯ç”¨æ™ºèƒ½è¯¯æŠ¥è¿‡æ»¤
- `--fp-density-threshold`: å¯†åº¦é˜ˆå€¼ (é»˜è®¤: 0.4)
- `--fp-area-threshold`: é¢ç§¯é˜ˆå€¼ (é»˜è®¤: 150000)
- `--fp-score-threshold`: è¯„åˆ†é˜ˆå€¼ (é»˜è®¤: 3)

### 2. åŒºåŸŸåˆ†æ

è¿›è¡Œè¯¦ç»†çš„è¿é€šåŸŸç»Ÿè®¡åˆ†æï¼š

```bash
python area_analysis.py pretrained/twoimages_epoch1000.pth \
  --input-dir ./data/test_images \
  --output-dir ./analysis_results \
  --enable-false-positive-filter \
  --enable-component-merge
```

### 3. æ¨¡å‹è®­ç»ƒ

è®­ç»ƒæ–°çš„UNetæ¨¡å‹ï¼š

```bash
# åŸºç¡€è®­ç»ƒ
python train.py --epochs 100 --batch-size 2 --learning-rate 1e-4

# å‚¬åŒ–å‰‚ä¸“ç”¨è®­ç»ƒ
python train_catelyzer.py --data-dir ./data/training --epochs 200
```

### 4. å•å¼ å›¾åƒé¢„æµ‹

å¯¹å•å¼ å›¾åƒè¿›è¡Œé¢„æµ‹ï¼š

```bash
python predict.py --model pretrained/twoimages_epoch1000.pth \
  --input image.jpg --output result.png --viz
```

## ğŸ“Š è¾“å‡ºç»“æœ

### 1. æ£€æµ‹ç»“æœæ–‡ä»¶

- **å¯è§†åŒ–å›¾åƒ**: æ ‡æ³¨äº†æ£€æµ‹ç»“æœçš„åŸå›¾
- **ç»Ÿè®¡æ•°æ®**: CSVæ ¼å¼çš„è¯¦ç»†æ£€æµ‹æ•°æ®
- **åˆ†ææŠ¥å‘Š**: åŒ…å«ç»Ÿè®¡å›¾è¡¨çš„ç»¼åˆæŠ¥å‘Š

### 2. æ–‡ä»¶ç»“æ„ç¤ºä¾‹

```
results/
â”œâ”€â”€ vis_images/           # å¯è§†åŒ–ç»“æœå›¾åƒ
â”‚   â”œâ”€â”€ image1_result.jpg
â”‚   â””â”€â”€ image2_result.jpg
â”œâ”€â”€ statistics/           # ç»Ÿè®¡æ•°æ®
â”‚   â”œâ”€â”€ detection_summary.csv
â”‚   â””â”€â”€ component_details.csv
â””â”€â”€ analysis/            # åˆ†ææŠ¥å‘Š
    â”œâ”€â”€ distribution_plots.png
    â””â”€â”€ statistical_report.html
```

### 3. æ£€æµ‹ç±»åˆ«

- **æ­£å¸¸å‚¬åŒ–å‰‚**: ç¬¦åˆè§„æ ¼çš„æ­£å¸¸é¢—ç²’
- **å¼‚ç‰©**: éå‚¬åŒ–å‰‚çš„å¤–æ¥ç‰©è´¨
- **å¼‚å½¢**: å˜å½¢ã€ç ´æŸçš„å‚¬åŒ–å‰‚é¢—ç²’

## ğŸ”§ é…ç½®æ–‡ä»¶

### ä¸»è¦é…ç½®ç±» (DetectionConfig)

```python
@dataclass
class DetectionConfig:
    # å›¾åƒå¤„ç†å‚æ•°
    YUV_BRIGHTNESS_THRESHOLD: int = 15
    UNET_SCALE_FACTOR: float = 0.5
    
    # è¿é€šåŸŸè¿‡æ»¤å‚æ•°  
    MIN_CONTOUR_POINTS: int = 10
    MIN_COMPONENT_FOR_ORIENTATION: int = 5
    
    # å½¢æ€å­¦å‚æ•°
    EROSION_KERNEL_SIZE: Tuple[int, int] = (3, 3)
    DILATION_KERNEL_SIZE: Tuple[int, int] = (5, 5)
    
    # å‡ ä½•ç‰¹å¾é˜ˆå€¼
    MIN_CONTOUR_LENGTH: int = 3
    CURVATURE_SCALE_FACTOR: float = 50
```

## ğŸ“ é¡¹ç›®ç»“æ„

```
catelyzer_seg/
â”œâ”€â”€ merge_test_yiwu.py      # ä¸»æ£€æµ‹ç³»ç»Ÿ
â”œâ”€â”€ area_analysis.py        # åŒºåŸŸåˆ†æå·¥å…·
â”œâ”€â”€ train.py               # UNetè®­ç»ƒè„šæœ¬
â”œâ”€â”€ predict.py             # é¢„æµ‹è„šæœ¬
â”œâ”€â”€ evaluate.py            # æ¨¡å‹è¯„ä¼°
â”œâ”€â”€ requirements.txt       # ä¾èµ–åˆ—è¡¨
â”œâ”€â”€ Dockerfile            # Dockeré…ç½®
â”œâ”€â”€ unet/                 # UNetæ¨¡å‹å®šä¹‰
â”‚   â”œâ”€â”€ unet_model.py
â”‚   â””â”€â”€ unet_parts.py
â”œâ”€â”€ utils/                # å·¥å…·å‡½æ•°
â”‚   â”œâ”€â”€ data_loading.py   # æ•°æ®åŠ è½½
â”‚   â”œâ”€â”€ dice_score.py     # æŸå¤±å‡½æ•°
â”‚   â””â”€â”€ utils.py          # é€šç”¨å·¥å…·
â”œâ”€â”€ datasets/             # æ•°æ®é›†å¤„ç†
â”œâ”€â”€ scripts/              # è¾…åŠ©è„šæœ¬
â”‚   â”œâ”€â”€ 01_merge_test.sh  # é•¿åº¦æµ‹é‡è„šæœ¬
â”‚   â””â”€â”€ 02_merge_test_yiwu.sh  # å¼‚ç‰©æ£€æµ‹è„šæœ¬
â”œâ”€â”€ data/                 # æ•°æ®ç›®å½•
â””â”€â”€ pretrained/           # é¢„è®­ç»ƒæ¨¡å‹
```

## ğŸ”¬ ç®—æ³•åŸç†

### 1. UNetåˆ†å‰²ç½‘ç»œ
- **ç¼–ç å™¨-è§£ç å™¨ç»“æ„**: æœ‰æ•ˆæå–å¤šå°ºåº¦ç‰¹å¾
- **è·³è·ƒè¿æ¥**: ä¿ç•™ç»†èŠ‚ä¿¡æ¯
- **åƒç´ çº§é¢„æµ‹**: ç²¾ç¡®çš„è¾¹ç•Œåˆ†å‰²

### 2. è¿é€šåŸŸåˆ†æ
- **è½®å»“æå–**: åŸºäºOpenCVçš„è½®å»“æ£€æµ‹
- **ç‰¹å¾è®¡ç®—**: é¢ç§¯ã€å‘¨é•¿ã€é•¿å®½æ¯”ã€å®å¿ƒåº¦ç­‰
- **å½¢æ€å­¦å¤„ç†**: å¼€è¿ç®—ã€é—­è¿ç®—ä¼˜åŒ–åˆ†å‰²ç»“æœ

### 3. æ™ºèƒ½åˆå¹¶ç®—æ³•
- **è·ç¦»åˆ¤æ–­**: åŸºäºè´¨å¿ƒè·ç¦»çš„é‚»è¿‘æ€§åˆ†æ
- **è§’åº¦çº¦æŸ**: ä¸»è½´æ–¹å‘çš„ä¸€è‡´æ€§æ£€éªŒ
- **é¢ç§¯æ¯”ä¾‹**: é¿å…é”™è¯¯åˆå¹¶ä¸åŒå¤§å°çš„åŒºåŸŸ

### 4. è¯¯æŠ¥è¿‡æ»¤æœºåˆ¶
- **å¯†åº¦ç‰¹å¾**: åŸºäºæœ€å°å¤–æ¥çŸ©å½¢çš„åƒç´ å¯†åº¦
- **å½¢çŠ¶å¤æ‚åº¦**: è½®å»“å¤æ‚æ€§åˆ†æ
- **ç»¼åˆè¯„åˆ†**: å¤šå› å­åŠ æƒè¯„åˆ†ç³»ç»Ÿ

## âš¡ æ€§èƒ½ä¼˜åŒ–

### 1. GPUåŠ é€Ÿ
- æ”¯æŒCUDA GPUåŠ é€Ÿæ¨ç†
- è‡ªåŠ¨æ£€æµ‹å¯ç”¨GPUè®¾å¤‡
- å†…å­˜ä¼˜åŒ–çš„æ‰¹å¤„ç†

### 2. æ•°æ®å¤„ç†ä¼˜åŒ–
- LMDBæ•°æ®åº“æ”¯æŒå¤§è§„æ¨¡æ•°æ®
- å¤šè¿›ç¨‹æ•°æ®åŠ è½½
- å†…å­˜æ˜ å°„å‡å°‘IOå¼€é”€

### 3. ç®—æ³•ä¼˜åŒ–
- å‘é‡åŒ–æ•°å­¦è¿ç®—
- é«˜æ•ˆçš„å›¾åƒå¤„ç†ç®—æ³•
- æ™ºèƒ½ç¼“å­˜æœºåˆ¶

## ğŸ› æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **CUDAå†…å­˜ä¸è¶³**
   ```bash
   # é™ä½æ‰¹å¤„ç†å¤§å°æˆ–ä½¿ç”¨CPU
   export CUDA_VISIBLE_DEVICES=""
   ```

2. **æ¨¡å‹åŠ è½½å¤±è´¥**
   ```bash
   # æ£€æŸ¥æ¨¡å‹æ–‡ä»¶è·¯å¾„å’Œå®Œæ•´æ€§
   ls -la pretrained/twoimages_epoch1000.pth
   ```

3. **ä¾èµ–åŒ…å†²çª**
   ```bash
   # ä½¿ç”¨è™šæ‹Ÿç¯å¢ƒ
   python -m venv catalyst_env
   source catalyst_env/bin/activate
   pip install -r requirements.txt
   ```

### æ—¥å¿—è°ƒè¯•

```bash
# å¯ç”¨è¯¦ç»†æ—¥å¿—
python merge_test_yiwu.py --log-level DEBUG
```

## ğŸ“ˆ æ›´æ–°æ—¥å¿—

### v2.0 (æœ€æ–°)
- âœ… æ–°å¢æ™ºèƒ½è¿é€šåŸŸåˆå¹¶åŠŸèƒ½
- âœ… ä¼˜åŒ–è¯¯æŠ¥è¿‡æ»¤ç®—æ³•
- âœ… å¢å¼ºå¯è§†åŒ–æ•ˆæœ
- âœ… æ”¯æŒæ‰¹é‡ç»Ÿè®¡åˆ†æ

### v1.0
- âœ… åŸºç¡€UNetåˆ†å‰²åŠŸèƒ½
- âœ… è¿é€šåŸŸç‰¹å¾æå–
- âœ… ç®€å•å¼‚å¸¸æ£€æµ‹

## ğŸ¤ è´¡çŒ®æŒ‡å—

1. Forkæœ¬é¡¹ç›®
2. åˆ›å»ºåŠŸèƒ½åˆ†æ”¯ (`git checkout -b feature/AmazingFeature`)
3. æäº¤æ›´æ”¹ (`git commit -m 'Add some AmazingFeature'`)
4. æ¨é€åˆ°åˆ†æ”¯ (`git push origin feature/AmazingFeature`)
5. å¼€å¯Pull Request

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®ä½¿ç”¨GNU General Public License v3.0è®¸å¯è¯ - æŸ¥çœ‹ [LICENSE](LICENSE) æ–‡ä»¶äº†è§£è¯¦æƒ…ã€‚

## ğŸ“§ è”ç³»æ–¹å¼

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·é€šè¿‡ä»¥ä¸‹æ–¹å¼è”ç³»ï¼š

- é¡¹ç›®Issues: [GitHub Issues](é¡¹ç›®GitHubåœ°å€/issues)
- é‚®ç®±: your-email@example.com

## ğŸ™ è‡´è°¢

- PyTorchå›¢é˜Ÿæä¾›çš„æ·±åº¦å­¦ä¹ æ¡†æ¶
- OpenCVç¤¾åŒºçš„è®¡ç®—æœºè§†è§‰æ”¯æŒ
- æ‰€æœ‰è´¡çŒ®è€…å’Œæµ‹è¯•ç”¨æˆ·çš„å®è´µåé¦ˆ

---

*æœ¬é¡¹ç›®è‡´åŠ›äºå·¥ä¸šè´¨é‡æ£€æµ‹çš„æ™ºèƒ½åŒ–å‡çº§ï¼Œä¸ºå‚¬åŒ–å‰‚ç”Ÿäº§æä¾›å¯é çš„è§†è§‰æ£€æµ‹è§£å†³æ–¹æ¡ˆã€‚* 